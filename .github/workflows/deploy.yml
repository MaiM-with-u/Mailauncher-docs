name: è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²æ–‡æ¡£

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: æ„å»ºé¡¹ç›®
      run: npm run docs:build
      env:
        NODE_OPTIONS: --max_old_space_size=4096

    - name: æ£€æŸ¥æ„å»ºäº§ç‰©
      run: |
        echo "ğŸ“¦ æ„å»ºäº§ç‰©æ£€æŸ¥..."
        ls -la docs/.vitepress/dist/
        if [ ! -f "docs/.vitepress/dist/index.html" ]; then
          echo "âŒ index.html ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
        echo "ğŸ“Š æ„å»ºäº§ç‰©å¤§å°: $(du -sh docs/.vitepress/dist | cut -f1)"
        
        # æ£€æŸ¥ assets ç›®å½•
        echo "ğŸ¨ Assets æ–‡ä»¶æ£€æŸ¥:"
        if [ -d "docs/.vitepress/dist/assets" ]; then
          echo "   âœ… assets ç›®å½•å­˜åœ¨"
          echo "   ğŸ“ assets æ–‡ä»¶æ€»æ•°: $(find docs/.vitepress/dist/assets -type f | wc -l)"
          echo "   ğŸ”¤ å­—ä½“æ–‡ä»¶æ•°é‡: $(find docs/.vitepress/dist/assets -name "*.woff*" | wc -l)"
        else
          echo "   âŒ assets ç›®å½•ä¸å­˜åœ¨ï¼Œè¿™å°†å¯¼è‡´404é”™è¯¯ï¼"
          exit 1
        fi

    # ä»…åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶æ‰éƒ¨ç½²
    - name: æ¸…ç†æœåŠ¡å™¨ç›®å½•
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          DEPLOY_PATH="${{ secrets.SERVER_DEPLOY_PATH }}"
          echo "ğŸ§¹ æ¸…ç†éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
          mkdir -p "$DEPLOY_PATH"
          find "$DEPLOY_PATH" -type f -delete 2>/dev/null || true
          find "$DEPLOY_PATH" -type d -empty -delete 2>/dev/null || true
          echo "âœ… ç›®å½•æ¸…ç†å®Œæˆ"

    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: burnett01/rsync-deployments@7.0.1
      with:
        switches: -avzr --delete
        path: docs/.vitepress/dist/
        remote_path: ${{ secrets.SERVER_DEPLOY_PATH }}
        remote_host: ${{ secrets.SERVER_HOST }}
        remote_user: ${{ secrets.SERVER_USERNAME }}
        remote_key: ${{ secrets.SERVER_SSH_KEY }}
        remote_port: ${{ secrets.SERVER_PORT || 22 }}

    - name: éªŒè¯éƒ¨ç½²ç»“æœ
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."
          DEPLOY_PATH="${{ secrets.SERVER_DEPLOY_PATH }}"
          
          if [ ! -d "$DEPLOY_PATH" ]; then
            echo "âŒ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨: $DEPLOY_PATH"
            exit 1
          fi
          
          if [ ! -f "$DEPLOY_PATH/index.html" ]; then
            echo "âŒ index.html æ–‡ä»¶ä¸å­˜åœ¨"
            echo "ğŸ“‚ å½“å‰ç›®å½•å†…å®¹:"
            ls -la "$DEPLOY_PATH"
            exit 1
          fi
          
          echo "âœ… æ ¸å¿ƒæ–‡ä»¶éªŒè¯æˆåŠŸ!"
          echo "ğŸ“‚ éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
          echo "ğŸ“„ æ–‡ä»¶æ•°é‡: $(find "$DEPLOY_PATH" -type f | wc -l)"
          
          # é‡ç‚¹æ£€æŸ¥ assets ç›®å½•
          echo "ğŸ¨ ASSETS ç›®å½•æ£€æŸ¥:"
          if [ -d "$DEPLOY_PATH/assets" ]; then
            echo "âœ… assets ç›®å½•å­˜åœ¨"
            echo "   ğŸ“„ assets æ–‡ä»¶æ€»æ•°: $(find "$DEPLOY_PATH/assets" -type f | wc -l)"
            echo "   ğŸ”¤ å­—ä½“æ–‡ä»¶: $(find "$DEPLOY_PATH/assets" -name "*.woff*" | wc -l) ä¸ª"
            echo "   ğŸ“‹ å‰5ä¸ªæ–‡ä»¶:"
            find "$DEPLOY_PATH/assets" -type f | head -5
          else
            echo "âŒ assets ç›®å½•ä¸å­˜åœ¨ï¼è¿™æ˜¯å¯¼è‡´404é”™è¯¯çš„åŸå› ï¼"
            echo "ğŸ“‚ éƒ¨ç½²ç›®å½•å†…å®¹:"
            ls -la "$DEPLOY_PATH"
            exit 1
          fi
          
          echo "ğŸŒ ç½‘ç«™åº”è¯¥å¯ä»¥åœ¨ http://${{ secrets.SERVER_HOST }}/ è®¿é—®"