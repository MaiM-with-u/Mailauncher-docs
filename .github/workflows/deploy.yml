name: è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²æ–‡æ¡£

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: æ„å»ºé¡¹ç›®
      run: npm run docs:build
      env:
        NODE_OPTIONS: --max_old_space_size=4096

    - name: æ£€æŸ¥æ„å»ºäº§ç‰©
      run: |
        echo "ğŸ“¦ æ„å»ºäº§ç‰©æ£€æŸ¥..."
        ls -la docs/.vitepress/dist/
        if [ ! -f "docs/.vitepress/dist/index.html" ]; then
          echo "âŒ index.html ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
        echo "ğŸ“Š æ„å»ºäº§ç‰©å¤§å°: $(du -sh docs/.vitepress/dist | cut -f1)"

    # ä»…åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶æ‰éƒ¨ç½²
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: "./docs/.vitepress/dist/"
        target: "${{ secrets.SERVER_DEPLOY_PATH }}"
        strip_components: 3
        overwrite: true
        timeout: 120s

    - name: éªŒè¯éƒ¨ç½²ç»“æœ
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."
          DEPLOY_PATH="${{ secrets.SERVER_DEPLOY_PATH }}"
          
          if [ ! -d "$DEPLOY_PATH" ]; then
            echo "âŒ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨: $DEPLOY_PATH"
            exit 1
          fi
          
          if [ ! -f "$DEPLOY_PATH/index.html" ]; then
            echo "âŒ index.html æ–‡ä»¶ä¸å­˜åœ¨"
            echo "ğŸ“‚ å½“å‰ç›®å½•å†…å®¹:"
            ls -la "$DEPLOY_PATH"
            exit 1
          fi
          
          echo "âœ… éƒ¨ç½²éªŒè¯æˆåŠŸ!"
          echo "ğŸ“‚ éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
          echo "ğŸ“„ æ–‡ä»¶æ•°é‡: $(find "$DEPLOY_PATH" -type f | wc -l)"
          echo "ğŸŒ ç½‘ç«™åº”è¯¥å¯ä»¥åœ¨ http://${{ secrets.SERVER_HOST }}/ è®¿é—®"