# é¡¹ç›®æ¶æ„æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† MaiLauncher çš„æ•´ä½“æ¶æ„è®¾è®¡å’ŒæŠ€æœ¯é€‰å‹ã€‚

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [æ¨¡å—è®¾è®¡](#æ¨¡å—è®¾è®¡)
- [æ•°æ®æµ](#æ•°æ®æµ)
- [å®‰å…¨è®¾è®¡](#å®‰å…¨è®¾è®¡)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [æ‰©å±•æ€§è®¾è®¡](#æ‰©å±•æ€§è®¾è®¡)

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„

MaiLauncher é‡‡ç”¨å‰åç«¯åˆ†ç¦»çš„æ¶æ„è®¾è®¡ï¼Œç”±ä»¥ä¸‹å‡ ä¸ªä¸»è¦ç»„ä»¶æ„æˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MaiLauncher ç³»ç»Ÿæ¶æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   å‰ç«¯åº”ç”¨       â”‚    â”‚   æ¡Œé¢åº”ç”¨       â”‚                â”‚
â”‚  â”‚   (Web UI)      â”‚    â”‚   (Tauri)       â”‚                â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚                â”‚
â”‚  â”‚  - Vue 3        â”‚    â”‚  - åŸç”Ÿé›†æˆ     â”‚                â”‚
â”‚  â”‚  - Vite         â”‚    â”‚  - ç³»ç»Ÿæ‰˜ç›˜     â”‚                â”‚
â”‚  â”‚  - Tailwind CSS â”‚    â”‚  - è‡ªåŠ¨å¯åŠ¨     â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚           â”‚                       â”‚                        â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                       â”‚                                    â”‚
â”‚                   HTTP/WebSocket                           â”‚
â”‚                       â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚                  åç«¯æœåŠ¡                                â”‚
â”‚  â”‚                 (FastAPI)                               â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  â”‚ å®ä¾‹ç®¡ç†å™¨   â”‚  â”‚ éƒ¨ç½²ç®¡ç†å™¨   â”‚  â”‚ ç³»ç»Ÿç›‘æ§å™¨   â”‚      â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚ - ç”Ÿå‘½å‘¨æœŸ   â”‚  â”‚ - ç‰ˆæœ¬ç®¡ç†   â”‚  â”‚ - å¥åº·æ£€æŸ¥   â”‚      â”‚
â”‚  â”‚  â”‚ - çŠ¶æ€ç›‘æ§   â”‚  â”‚ - è‡ªåŠ¨éƒ¨ç½²   â”‚  â”‚ - æ€§èƒ½ç›‘æ§   â”‚      â”‚
â”‚  â”‚  â”‚ - æœåŠ¡æ§åˆ¶   â”‚  â”‚ - ä¾èµ–ç®¡ç†   â”‚  â”‚ - æ—¥å¿—ç®¡ç†   â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  â”‚ èµ„æºç®¡ç†å™¨   â”‚  â”‚ é…ç½®ç®¡ç†å™¨   â”‚  â”‚ WebSocket   â”‚      â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚  ç®¡ç†å™¨     â”‚      â”‚
â”‚  â”‚  â”‚ - è¡¨æƒ…åŒ…     â”‚  â”‚ - Boté…ç½®    â”‚  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚ - ç”¨æˆ·ä¿¡æ¯   â”‚  â”‚ - LPMMé…ç½®   â”‚  â”‚ - ç»ˆç«¯ä¼šè¯   â”‚      â”‚
â”‚  â”‚  â”‚ - æ–‡ä»¶ç®¡ç†   â”‚  â”‚ - ç¯å¢ƒå˜é‡   â”‚  â”‚ - å®æ—¶é€šä¿¡   â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”‚                                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚                   æ•°æ®å±‚                                 â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  â”‚ SQLite æ•°æ®åº“â”‚  â”‚ æ–‡ä»¶ç³»ç»Ÿ     â”‚  â”‚ é…ç½®æ–‡ä»¶     â”‚      â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚ - å®ä¾‹ä¿¡æ¯   â”‚  â”‚ - æ—¥å¿—æ–‡ä»¶   â”‚  â”‚ - ç³»ç»Ÿé…ç½®   â”‚      â”‚
â”‚  â”‚  â”‚ - ç”¨æˆ·æ•°æ®   â”‚  â”‚ - é™æ€èµ„æº   â”‚  â”‚ - ç”¨æˆ·åå¥½   â”‚      â”‚
â”‚  â”‚  â”‚ - é…ç½®æ•°æ®   â”‚  â”‚ - ç¼“å­˜æ•°æ®   â”‚  â”‚ - è¿è¡Œæ—¶è®¾ç½® â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”‚                                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚                 MaiBot å®ä¾‹å±‚                            â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  â”‚ å®ä¾‹ A       â”‚  â”‚ å®ä¾‹ B       â”‚  â”‚ å®ä¾‹ C       â”‚      â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚      â”‚
â”‚  â”‚  â”‚ - NapCat    â”‚  â”‚ - NapCat    â”‚  â”‚ - NoneBot   â”‚      â”‚
â”‚  â”‚  â”‚ - NoneBot   â”‚  â”‚ - è‡ªå®šä¹‰æœåŠ¡ â”‚  â”‚ - æ’ä»¶ç³»ç»Ÿ   â”‚      â”‚
â”‚  â”‚  â”‚ - ç‹¬ç«‹ç«¯å£   â”‚  â”‚ - ç‹¬ç«‹é…ç½®   â”‚  â”‚ - æ•°æ®éš”ç¦»   â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”‚                                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶äº¤äº’

```mermaid
graph TB
    A[å‰ç«¯åº”ç”¨] --> B[HTTP API]
    A --> C[WebSocket]
    B --> D[å®ä¾‹ç®¡ç†å™¨]
    B --> E[éƒ¨ç½²ç®¡ç†å™¨]
    B --> F[ç³»ç»Ÿç›‘æ§å™¨]
    C --> G[WebSocketç®¡ç†å™¨]
    D --> H[SQLiteæ•°æ®åº“]
    E --> I[æ–‡ä»¶ç³»ç»Ÿ]
    F --> J[ç³»ç»ŸAPI]
    G --> K[ç»ˆç«¯ä¼šè¯]
    D --> L[MaiBotå®ä¾‹]
    E --> L
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### å‰ç«¯æŠ€æœ¯æ ˆ

#### æ ¸å¿ƒæ¡†æ¶
- **Vue 3**: æ¸è¿›å¼ JavaScript æ¡†æ¶
  - Composition API: æ›´å¥½çš„é€»è¾‘å¤ç”¨
  - Reactivity API: å“åº”å¼æ•°æ®ç®¡ç†
  - Teleport: ç»„ä»¶ä¼ é€é—¨
  - Fragments: å¤šæ ¹èŠ‚ç‚¹ç»„ä»¶

- **Vite**: ç°ä»£åŒ–æ„å»ºå·¥å…·
  - ES æ¨¡å—çƒ­æ›´æ–°
  - å¿«é€Ÿå†·å¯åŠ¨
  - ä¼˜åŒ–çš„æ„å»ºè¾“å‡º
  - æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ

#### UI æ¡†æ¶
- **Tailwind CSS**: å®ç”¨ä¼˜å…ˆçš„ CSS æ¡†æ¶
  - åŸå­åŒ– CSS ç±»
  - å“åº”å¼è®¾è®¡
  - æš—é»‘æ¨¡å¼æ”¯æŒ
  - è‡ªå®šä¹‰ä¸»é¢˜

- **DaisyUI**: åŸºäº Tailwind CSS çš„ç»„ä»¶åº“
  - é¢„åˆ¶ç»„ä»¶
  - å¤šä¸»é¢˜æ”¯æŒ
  - æ—  JavaScript ä¾èµ–
  - è¯­ä¹‰åŒ–ç±»å

#### çŠ¶æ€ç®¡ç†
- **Pinia**: Vue 3 çŠ¶æ€ç®¡ç†åº“
  - TypeScript å‹å¥½
  - æ¨¡å—åŒ–è®¾è®¡
  - å¼€å‘å·¥å…·æ”¯æŒ
  - æ’ä»¶ç³»ç»Ÿ

#### å·¥å…·åº“
- **Iconify**: å›¾æ ‡ç³»ç»Ÿ
- **xterm.js**: ç»ˆç«¯æ¨¡æ‹Ÿå™¨
- **ECharts**: æ•°æ®å¯è§†åŒ–
- **Day.js**: æ—¥æœŸå¤„ç†

#### æ¡Œé¢åº”ç”¨
- **Tauri**: è·¨å¹³å°æ¡Œé¢åº”ç”¨æ¡†æ¶
  - Rust åç«¯
  - å®‰å…¨æ€§ä¼˜å…ˆ
  - ä½“ç§¯å°å·§
  - åŸç”Ÿæ€§èƒ½

### åç«¯æŠ€æœ¯æ ˆ

#### æ ¸å¿ƒæ¡†æ¶
- **FastAPI**: ç°ä»£ Python Web æ¡†æ¶
  - è‡ªåŠ¨ API æ–‡æ¡£ç”Ÿæˆ
  - ç±»å‹æç¤ºæ”¯æŒ
  - é«˜æ€§èƒ½å¼‚æ­¥å¤„ç†
  - æ•°æ®éªŒè¯

- **Uvicorn**: ASGI æœåŠ¡å™¨
  - å¼‚æ­¥æ”¯æŒ
  - é«˜æ€§èƒ½
  - çƒ­é‡è½½
  - ç”Ÿäº§å°±ç»ª

#### æ•°æ®åº“
- **SQLite**: è½»é‡çº§æ•°æ®åº“
  - æ— æœåŠ¡å™¨
  - é›¶é…ç½®
  - è·¨å¹³å°
  - äº‹åŠ¡æ”¯æŒ

- **SQLAlchemy**: ORM æ¡†æ¶
  - å¯¹è±¡å…³ç³»æ˜ å°„
  - æŸ¥è¯¢æ„å»ºå™¨
  - è¿æ¥æ± 
  - æ•°æ®åº“è¿ç§»

#### å¼‚æ­¥å¤„ç†
- **asyncio**: Python å¼‚æ­¥ç¼–ç¨‹
  - äº‹ä»¶å¾ªç¯
  - åç¨‹æ”¯æŒ
  - å¹¶å‘æ§åˆ¶
  - å¼‚æ­¥ I/O

#### å·¥å…·åº“
- **Pydantic**: æ•°æ®éªŒè¯
- **python-multipart**: æ–‡ä»¶ä¸Šä¼ 
- **websockets**: WebSocket æ”¯æŒ
- **psutil**: ç³»ç»Ÿç›‘æ§

### å¼€å‘å·¥å…·

#### ä»£ç è´¨é‡
- **ESLint**: JavaScript ä»£ç æ£€æŸ¥
- **Prettier**: ä»£ç æ ¼å¼åŒ–
- **Black**: Python ä»£ç æ ¼å¼åŒ–
- **mypy**: Python ç±»å‹æ£€æŸ¥

#### æµ‹è¯•å·¥å…·
- **Vitest**: å‰ç«¯æµ‹è¯•æ¡†æ¶
- **pytest**: Python æµ‹è¯•æ¡†æ¶
- **Vue Test Utils**: Vue ç»„ä»¶æµ‹è¯•

#### æ„å»ºå·¥å…·
- **Vite**: å‰ç«¯æ„å»º
- **PyInstaller**: Python æ‰“åŒ…
- **Tauri**: æ¡Œé¢åº”ç”¨æ‰“åŒ…

## ğŸ”§ æ¨¡å—è®¾è®¡

### å‰ç«¯æ¨¡å—

#### 1. è·¯ç”±ç³»ç»Ÿ
```javascript
// src/router/index.js
const routes = [
  {
    path: '/',
    component: HomeView,
    children: [
      { path: 'instances', component: InstancesPanel },
      { path: 'deploy', component: DeployPanel },
      { path: 'monitor', component: MonitorPanel },
      { path: 'settings', component: SettingsPanel }
    ]
  }
];
```

#### 2. çŠ¶æ€ç®¡ç†
```javascript
// src/stores/instances.js
export const useInstancesStore = defineStore('instances', {
  state: () => ({
    instances: [],
    loading: false,
    error: null
  }),
  
  actions: {
    async fetchInstances() {
      this.loading = true;
      try {
        const response = await api.getInstances();
        this.instances = response.instances;
      } catch (error) {
        this.error = error.message;
      } finally {
        this.loading = false;
      }
    }
  }
});
```

#### 3. API æœåŠ¡
```javascript
// src/services/api.js
class ApiService {
  constructor() {
    this.baseURL = 'http://localhost:23456/api/v1';
  }

  async request(endpoint, options = {}) {
    const url = `${this.baseURL}${endpoint}`;
    const response = await fetch(url, {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    return response.json();
  }
}
```

### åç«¯æ¨¡å—

#### 1. å®ä¾‹ç®¡ç†å™¨
```python
# src/modules/instance_manager.py
class InstanceManager:
    def __init__(self):
        self.instances = {}
        self.db_manager = DatabaseManager()
    
    async def start_instance(self, instance_id: str):
        """å¯åŠ¨å®ä¾‹"""
        instance = self.instances.get(instance_id)
        if not instance:
            raise HTTPException(404, "å®ä¾‹ä¸å­˜åœ¨")
        
        await instance.start()
        return {"success": True, "message": f"å®ä¾‹ {instance.name} å·²å¯åŠ¨"}
    
    async def stop_instance(self, instance_id: str):
        """åœæ­¢å®ä¾‹"""
        instance = self.instances.get(instance_id)
        if not instance:
            raise HTTPException(404, "å®ä¾‹ä¸å­˜åœ¨")
        
        await instance.stop()
        return {"success": True, "message": f"å®ä¾‹ {instance.name} å·²åœæ­¢"}
```

#### 2. éƒ¨ç½²ç®¡ç†å™¨
```python
# src/modules/deploy_manager.py
class DeployManager:
    def __init__(self):
        self.download_manager = DownloadManager()
        self.install_manager = InstallManager()
    
    async def deploy_instance(self, config: DeployConfig):
        """éƒ¨ç½²æ–°å®ä¾‹"""
        # åˆ›å»ºéƒ¨ç½²ä»»åŠ¡
        task = DeployTask(config)
        
        # ä¸‹è½½æºç 
        await self.download_manager.download(config.version, config.install_path)
        
        # å®‰è£…ä¾èµ–
        await self.install_manager.install_dependencies(config.install_path)
        
        # å®‰è£…æœåŠ¡
        for service in config.services:
            await self.install_manager.install_service(service, config.install_path)
        
        # åˆ›å»ºå®ä¾‹è®°å½•
        instance_id = await self.create_instance_record(config)
        
        return {"success": True, "instance_id": instance_id}
```

#### 3. WebSocket ç®¡ç†å™¨
```python
# src/modules/websocket_manager.py
class WebSocketManager:
    def __init__(self):
        self.connections = {}
        self.terminals = {}
    
    async def connect(self, websocket: WebSocket, session_id: str):
        """å»ºç«‹ WebSocket è¿æ¥"""
        await websocket.accept()
        self.connections[session_id] = websocket
        
        # åˆ›å»ºç»ˆç«¯ä¼šè¯
        terminal = self.create_terminal_session(session_id)
        self.terminals[session_id] = terminal
        
        # å‘é€å†å²æ—¥å¿—
        await self.send_history_logs(websocket, session_id)
    
    async def handle_message(self, websocket: WebSocket, session_id: str, message: dict):
        """å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯"""
        if message["type"] == "input":
            terminal = self.terminals.get(session_id)
            if terminal:
                await terminal.write(message["data"])
```

## ğŸ”„ æ•°æ®æµ

### å®ä¾‹ç®¡ç†æ•°æ®æµ

```mermaid
sequenceDiagram
    participant F as å‰ç«¯
    participant A as APIæœåŠ¡
    participant IM as å®ä¾‹ç®¡ç†å™¨
    participant DB as æ•°æ®åº“
    participant I as MaiBotå®ä¾‹

    F->>A: è¯·æ±‚å¯åŠ¨å®ä¾‹
    A->>IM: è°ƒç”¨å¯åŠ¨æ–¹æ³•
    IM->>DB: æŸ¥è¯¢å®ä¾‹ä¿¡æ¯
    DB-->>IM: è¿”å›å®ä¾‹é…ç½®
    IM->>I: å¯åŠ¨å®ä¾‹è¿›ç¨‹
    I-->>IM: è¿”å›å¯åŠ¨ç»“æœ
    IM->>DB: æ›´æ–°å®ä¾‹çŠ¶æ€
    IM-->>A: è¿”å›æ“ä½œç»“æœ
    A-->>F: è¿”å›å“åº”
```

### éƒ¨ç½²ç®¡ç†æ•°æ®æµ

```mermaid
sequenceDiagram
    participant F as å‰ç«¯
    participant A as APIæœåŠ¡
    participant DM as éƒ¨ç½²ç®¡ç†å™¨
    participant FS as æ–‡ä»¶ç³»ç»Ÿ
    participant DB as æ•°æ®åº“

    F->>A: æäº¤éƒ¨ç½²è¯·æ±‚
    A->>DM: åˆ›å»ºéƒ¨ç½²ä»»åŠ¡
    DM->>FS: ä¸‹è½½æºç 
    FS-->>DM: ä¸‹è½½å®Œæˆ
    DM->>FS: å®‰è£…ä¾èµ–
    FS-->>DM: å®‰è£…å®Œæˆ
    DM->>DB: åˆ›å»ºå®ä¾‹è®°å½•
    DB-->>DM: è¿”å›å®ä¾‹ID
    DM-->>A: è¿”å›éƒ¨ç½²ç»“æœ
    A-->>F: è¿”å›å“åº”
```

### WebSocket æ•°æ®æµ

```mermaid
sequenceDiagram
    participant F as å‰ç«¯
    participant WS as WebSocketç®¡ç†å™¨
    participant T as ç»ˆç«¯ä¼šè¯
    participant P as ç³»ç»Ÿè¿›ç¨‹

    F->>WS: å»ºç«‹è¿æ¥
    WS->>T: åˆ›å»ºç»ˆç«¯ä¼šè¯
    T->>P: å¯åŠ¨ç»ˆç«¯è¿›ç¨‹
    P-->>T: è¿”å›è¿›ç¨‹å¥æŸ„
    T-->>WS: ä¼šè¯åˆ›å»ºæˆåŠŸ
    WS-->>F: è¿æ¥å»ºç«‹æˆåŠŸ
    
    F->>WS: å‘é€å‘½ä»¤
    WS->>T: å†™å…¥å‘½ä»¤
    T->>P: æ‰§è¡Œå‘½ä»¤
    P-->>T: è¿”å›è¾“å‡º
    T-->>WS: è½¬å‘è¾“å‡º
    WS-->>F: å‘é€è¾“å‡º
```

## ğŸ”’ å®‰å…¨è®¾è®¡

### 1. æœ¬åœ°åº”ç”¨å®‰å…¨

ç”±äº MaiLauncher æ˜¯æœ¬åœ°åº”ç”¨ï¼Œä¸»è¦å®‰å…¨è€ƒè™‘ï¼š

- **ç«¯å£ç»‘å®š**: ä»…ç»‘å®šåˆ° localhostï¼Œé¿å…å¤–éƒ¨è®¿é—®
- **æ–‡ä»¶æƒé™**: é™åˆ¶æ–‡ä»¶è®¿é—®æƒé™
- **è¿›ç¨‹éš”ç¦»**: æ¯ä¸ªå®ä¾‹è¿è¡Œåœ¨ç‹¬ç«‹è¿›ç¨‹ä¸­
- **æ•°æ®éªŒè¯**: ä¸¥æ ¼éªŒè¯æ‰€æœ‰è¾“å…¥æ•°æ®

### 2. æ–‡ä»¶ç³»ç»Ÿå®‰å…¨

```python
# è·¯å¾„éªŒè¯
def validate_path(path: str) -> bool:
    """éªŒè¯è·¯å¾„å®‰å…¨æ€§"""
    # ç¦æ­¢è·¯å¾„éå†
    if '..' in path or path.startswith('/'):
        return False
    
    # é™åˆ¶åœ¨å·¥ä½œç›®å½•å†…
    abs_path = os.path.abspath(path)
    work_dir = os.path.abspath(settings.WORK_DIR)
    
    return abs_path.startswith(work_dir)
```

### 3. è¿›ç¨‹ç®¡ç†å®‰å…¨

```python
# è¿›ç¨‹æƒé™æ§åˆ¶
def create_process(command: str, cwd: str) -> subprocess.Popen:
    """åˆ›å»ºå—é™è¿›ç¨‹"""
    # è®¾ç½®ç¯å¢ƒå˜é‡
    env = os.environ.copy()
    env['PATH'] = settings.SAFE_PATH
    
    # åˆ›å»ºè¿›ç¨‹
    process = subprocess.Popen(
        command,
        cwd=cwd,
        env=env,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )
    
    return process
```

### 4. æ•°æ®åº“å®‰å…¨

```python
# å‚æ•°åŒ–æŸ¥è¯¢
def get_instance(instance_id: str) -> Optional[Instance]:
    """å®‰å…¨çš„æ•°æ®åº“æŸ¥è¯¢"""
    query = "SELECT * FROM instances WHERE id = ?"
    result = db.execute(query, (instance_id,)).fetchone()
    return Instance.from_row(result) if result else None
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### ä»£ç åˆ†å‰²
```javascript
// è·¯ç”±æ‡’åŠ è½½
const routes = [
  {
    path: '/instances',
    component: () => import('./views/InstancesView.vue')
  },
  {
    path: '/deploy',
    component: () => import('./views/DeployView.vue')
  }
];
```

#### ç»„ä»¶ä¼˜åŒ–
```vue
<!-- è™šæ‹Ÿæ»šåŠ¨ -->
<template>
  <VirtualList
    :items="instances"
    :item-height="80"
    :container-height="400"
  >
    <template #item="{ item }">
      <InstanceCard :instance="item" />
    </template>
  </VirtualList>
</template>
```

#### çŠ¶æ€ä¼˜åŒ–
```javascript
// è®¡ç®—å±æ€§ç¼“å­˜
export const useInstancesStore = defineStore('instances', {
  state: () => ({
    instances: [],
    filter: ''
  }),
  
  getters: {
    filteredInstances: (state) => {
      if (!state.filter) return state.instances;
      return state.instances.filter(instance => 
        instance.name.toLowerCase().includes(state.filter.toLowerCase())
      );
    }
  }
});
```

### 2. åç«¯æ€§èƒ½ä¼˜åŒ–

#### å¼‚æ­¥å¤„ç†
```python
# å¹¶å‘å¤„ç†
async def process_instances_batch(instance_ids: List[str]):
    """æ‰¹é‡å¤„ç†å®ä¾‹"""
    tasks = []
    for instance_id in instance_ids:
        task = asyncio.create_task(process_instance(instance_id))
        tasks.append(task)
    
    results = await asyncio.gather(*tasks, return_exceptions=True)
    return results
```

#### æ•°æ®åº“ä¼˜åŒ–
```python
# è¿æ¥æ± 
from sqlalchemy.pool import StaticPool

engine = create_engine(
    "sqlite:///mailauncher.db",
    poolclass=StaticPool,
    pool_size=10,
    max_overflow=20
)
```

#### ç¼“å­˜ç­–ç•¥
```python
# å†…å­˜ç¼“å­˜
from functools import lru_cache
from typing import Dict, Any

@lru_cache(maxsize=128)
def get_instance_config(instance_id: str) -> Dict[str, Any]:
    """è·å–å®ä¾‹é…ç½®ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
    config_path = f"instances/{instance_id}/config.json"
    with open(config_path, 'r') as f:
        return json.load(f)
```

### 3. ç³»ç»Ÿèµ„æºä¼˜åŒ–

#### å†…å­˜ç®¡ç†
```python
# å®šæœŸæ¸…ç†
async def cleanup_resources():
    """æ¸…ç†ç³»ç»Ÿèµ„æº"""
    # æ¸…ç†è¿‡æœŸä¼šè¯
    expired_sessions = []
    for session_id, session in websocket_manager.sessions.items():
        if session.is_expired():
            expired_sessions.append(session_id)
    
    for session_id in expired_sessions:
        await websocket_manager.close_session(session_id)
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    temp_dir = Path("temp")
    for file in temp_dir.glob("*"):
        if file.stat().st_mtime < time.time() - 3600:  # 1å°æ—¶
            file.unlink()
```

## ğŸ”§ æ‰©å±•æ€§è®¾è®¡

### 1. æ’ä»¶ç³»ç»Ÿ

```python
# æ’ä»¶æ¥å£
class PluginInterface:
    """æ’ä»¶æ¥å£"""
    
    def __init__(self, name: str, version: str):
        self.name = name
        self.version = version
    
    async def initialize(self, context: PluginContext):
        """åˆå§‹åŒ–æ’ä»¶"""
        pass
    
    async def on_instance_start(self, instance: Instance):
        """å®ä¾‹å¯åŠ¨æ—¶è§¦å‘"""
        pass
    
    async def on_instance_stop(self, instance: Instance):
        """å®ä¾‹åœæ­¢æ—¶è§¦å‘"""
        pass
    
    def get_routes(self) -> List[APIRoute]:
        """è·å–æ’ä»¶è·¯ç”±"""
        return []
```

### 2. é…ç½®ç³»ç»Ÿ

```python
# é…ç½®ç®¡ç†
class ConfigManager:
    def __init__(self):
        self.config = {}
        self.watchers = []
    
    def load_config(self, config_path: str):
        """åŠ è½½é…ç½®"""
        with open(config_path, 'r') as f:
            self.config = json.load(f)
    
    def get(self, key: str, default=None):
        """è·å–é…ç½®å€¼"""
        keys = key.split('.')
        value = self.config
        
        for k in keys:
            value = value.get(k)
            if value is None:
                return default
        
        return value
    
    def set(self, key: str, value: Any):
        """è®¾ç½®é…ç½®å€¼"""
        keys = key.split('.')
        config = self.config
        
        for k in keys[:-1]:
            config = config.setdefault(k, {})
        
        config[keys[-1]] = value
        self.notify_watchers(key, value)
    
    def watch(self, key: str, callback: Callable):
        """ç›‘å¬é…ç½®å˜åŒ–"""
        self.watchers.append((key, callback))
```

### 3. äº‹ä»¶ç³»ç»Ÿ

```python
# äº‹ä»¶æ€»çº¿
class EventBus:
    def __init__(self):
        self.listeners = defaultdict(list)
    
    def on(self, event: str, callback: Callable):
        """æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨"""
        self.listeners[event].append(callback)
    
    def off(self, event: str, callback: Callable):
        """ç§»é™¤äº‹ä»¶ç›‘å¬å™¨"""
        if callback in self.listeners[event]:
            self.listeners[event].remove(callback)
    
    async def emit(self, event: str, data: Any = None):
        """å‘å¸ƒäº‹ä»¶"""
        for callback in self.listeners[event]:
            try:
                if asyncio.iscoroutinefunction(callback):
                    await callback(event, data)
                else:
                    callback(event, data)
            except Exception as e:
                logger.error(f"äº‹ä»¶å¤„ç†å¤±è´¥: {e}")
```

### 4. æ¨¡å—åŒ–è®¾è®¡

```python
# æ¨¡å—æ³¨å†Œ
class ModuleManager:
    def __init__(self):
        self.modules = {}
    
    def register_module(self, name: str, module: Any):
        """æ³¨å†Œæ¨¡å—"""
        self.modules[name] = module
        logger.info(f"æ¨¡å— {name} å·²æ³¨å†Œ")
    
    def get_module(self, name: str) -> Any:
        """è·å–æ¨¡å—"""
        return self.modules.get(name)
    
    def load_modules(self, modules_dir: str):
        """åŠ è½½æ¨¡å—ç›®å½•"""
        for file in Path(modules_dir).glob("*.py"):
            module_name = file.stem
            spec = importlib.util.spec_from_file_location(module_name, file)
            module = importlib.util.module_from_spec(spec)
            spec.loader.exec_module(module)
            
            if hasattr(module, 'register'):
                module.register(self)
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. æ€§èƒ½ç›‘æ§

```python
# æ€§èƒ½æŒ‡æ ‡æ”¶é›†
class MetricsCollector:
    def __init__(self):
        self.metrics = {}
    
    def record_request(self, endpoint: str, duration: float, status_code: int):
        """è®°å½•è¯·æ±‚æŒ‡æ ‡"""
        key = f"request_{endpoint}_{status_code}"
        if key not in self.metrics:
            self.metrics[key] = []
        
        self.metrics[key].append({
            'timestamp': time.time(),
            'duration': duration
        })
    
    def get_metrics(self) -> Dict[str, Any]:
        """è·å–æ€§èƒ½æŒ‡æ ‡"""
        return {
            'total_requests': sum(len(values) for values in self.metrics.values()),
            'avg_response_time': self.calculate_avg_response_time(),
            'error_rate': self.calculate_error_rate()
        }
```

### 2. ç»“æ„åŒ–æ—¥å¿—

```python
# æ—¥å¿—é…ç½®
import structlog

structlog.configure(
    processors=[
        structlog.stdlib.filter_by_level,
        structlog.stdlib.add_logger_name,
        structlog.stdlib.add_log_level,
        structlog.stdlib.PositionalArgumentsFormatter(),
        structlog.processors.TimeStamper(fmt="iso"),
        structlog.processors.StackInfoRenderer(),
        structlog.processors.format_exc_info,
        structlog.processors.JSONRenderer()
    ],
    context_class=dict,
    logger_factory=structlog.stdlib.LoggerFactory(),
    wrapper_class=structlog.stdlib.BoundLogger,
    cache_logger_on_first_use=True,
)

# ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
logger = structlog.get_logger()

async def start_instance(instance_id: str):
    logger.info(
        "å¼€å§‹å¯åŠ¨å®ä¾‹",
        instance_id=instance_id,
        action="start_instance"
    )
    
    try:
        # å¯åŠ¨é€»è¾‘
        pass
    except Exception as e:
        logger.error(
            "å®ä¾‹å¯åŠ¨å¤±è´¥",
            instance_id=instance_id,
            error=str(e),
            action="start_instance"
        )
        raise
```

è¿™ä¸ªæ¶æ„æ–‡æ¡£è¯¦ç»†æè¿°äº† MaiLauncher çš„ç³»ç»Ÿè®¾è®¡ï¼Œä¸ºå¼€å‘è€…æä¾›äº†å…¨é¢çš„æŠ€æœ¯å‚è€ƒã€‚é€šè¿‡æ¨¡å—åŒ–è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–å’Œæ‰©å±•æ€§è€ƒè™‘ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿé•¿æœŸç¨³å®šè¿è¡Œå¹¶æ”¯æŒæœªæ¥çš„åŠŸèƒ½æ‰©å±•ã€‚
